@model IEnumerable<OnlineBanking.DAL.Channels>

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
<div class="page-titles">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
        <li class="breadcrumb-item active"><a href="@Url.Action("Index", "Channels")">Messages</a></li>
    </ol>
</div>

<div class="row">
    <div id="user-list" class="col-xl-12">
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header d-sm-flex d-block shadow-sm border-0 align-items-center">
                        <div class="card-action card-tabs">
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#AllMessage" role="tab" aria-selected="false">
                                        All Message
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-toggle="tab" href="#Unread" role="tab" aria-selected="false">
                                        Unread
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body message-bx dlab-scroll height640 ps ps--active-y" id="message-bx">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="AllMessage" role="tabpanel">

                            </div>
                            <div class="tab-pane fade" id="Unread" role="tabpanel">
                                <div class="media mb-4">
                                    <div class="image-bx mr-sm-4 mr-2">
                                        <img src="https://vora.dexignlab.com/laravel/demo/images/users/3.png" alt="" class="rounded-circle img-1">
                                        <span class="active"></span>
                                    </div>
                                    <div class="media-body">
                                        <div class="d-flex mb-sm-2 mb-0">
                                            <h6 class="text-black font-w600 fs-16 mb-0">Roberto Charloz</h6>
                                            <span class="ml-auto fs-14">2m ago</span>
                                        </div>
                                        <p class="text-black">Hey, check my design update last night. Tell me what you think and if that is OK. I hear client said they want to change the layout concept</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps__rail-y" style="top: 0px; height: 496px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 241px;"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="chat-list" class="col-xl-7" style="display: none;">
        <div class="row">
            <div class="col-xl-12">
                <div class="card message-bx chat-box">
                    <div class="card-header border-0 shadow-sm">
                        <div class="d-flex mr-auto align-items-center">
                            <div class="image-bx mr-sm-4 mr-2">
                                <img src="https://vora.dexignlab.com/laravel/demo/images/users/5.png" alt="" class="rounded-circle img-1">
                                <span class="active"></span>
                            </div>
                            <div>
                                <h5 id="user-name" class="text-black font-w600 mb-sm-1 mb-0 title-nm">User name</h5>
                                <span id="user-timestamp">Timestamp</span>
                            </div>
                        </div>

                        <button type="button" class="close btn-close" data-dismiss="modal">
                            <span>×</span>
                        </button>
                    </div>
                    <div class="card-body dlab-scroll height520 ps ps--active-y" id="discussion">
                        @*<div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps__rail-y" style="top: 0px; height: 616px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 506px;"></div></div>*@
                    </div>
                    <div class="card-footer border-0 type-massage">
                        <form id="chat" onsubmit="return false;">
                            <div class="input-group">
                                <textarea id="message" name="message" class="form-control" placeholder="Type message..."></textarea>
                                <input type="hidden" id="channel" name="channel" value="0">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Content/vendor/moment/moment.min.js" type="text/javascript"></script>
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->

    <script>
        $.connection.hub.qs = { "userId": '@Session["userId"]' };

        var connection = $.connection;
        var chatHub = connection.chatHub;
        var accountId = connection.hub.qs.userId;

        var managerChannel = {
            load: function (page = 1, key = null) {
                $.ajax({
                    type: "GET",
                    url: "/Admin/Channels/GetData",
                    data: { page: page, key: key },
                    success: function (res) {

                        let _html = "";
                        var ii = 1;
                        for (let item of res.data) {
                            _html += `
                                <div class="media mb-4 btn-reply" data-channel="${item.ChannelId ?? ''}" data-name="${item.AccountName ?? ''}" data-timestamp="${item.LastUpdated ?? ""}">
                                    <div class="image-bx mr-sm-4 mr-2">
                                        <img src="https://vora.dexignlab.com/laravel/demo/images/users/3.png" alt="" class="rounded-circle img-1">
                                        <span class="active"></span>
                                    </div>
                                    <div class="media-body">
                                        <div class="d-flex mb-sm-2 mb-0">
                                            <a href="/Admin/Accounts/ProfileAccount/${item.AccountId ?? '0'}" onclick="return false;">
                                                <h6 class="text-black font-w600 fs-16 mb-0">${item.AccountName ?? ""}</h6>
                                            </a>
                                            <span class="ml-auto fs-14">${moment(item.LastUpdated ?? "").fromNow()}</span>
                                        </div>
                                        <p class="text-black">${item.LastMessages ?? ""}</p>
                                    </div>
                                </div>`;

                            ii++;
                        }
                        $('#AllMessage').html(_html);
                    }
                });
            },
        };

        $(function () {
            managerChannel.load();

            $("#message").keypress(function (e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();

                    $("#chat").submit();
                }
            });

            $("#key").keyup(function () {
                let key = $("#key").val();
                managerChannel.load(1, key);
            });

            $(document).on("click", ".item-page", function () {
                let page = $(this).text();
                let key = $("#key").val();
                managerChannel.load(page, key);
            });

            chatHub.client.updateUser = function (userView) {
                console.log(userView);
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.newMessage = function (messageView) {
                var msg = connvertMessage(accountId, messageView);

                $('#discussion')
                    .append(msg)
                    .ready(function () {
                        $('#discussion').animate({ scrollTop: $('#discussion').prop("scrollHeight") }, 150);
                    });
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.historyMessages = function (historyMessages) {
                console.log(historyMessages.length);
                if (historyMessages.length >= 10) {
                    $('#discussion')
                        .html('<button type="button" class="btn btn-primary btn-sm btn-block mb-3 btn-loadmore">Load more message!</button>');
                }
                var msg = "";

                for (let messageView of historyMessages) {
                    msg += connvertMessage(accountId, messageView);
                }

                $('#discussion').append(msg);
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.reloadChatData = function () {
                managerChannel.load();
            };

            //// Create a function that the hub can call back to display messages.
            //chatHub.client.onlineList = function (data) {
            //    let _html = "";
            //    for (let item of res.data) {
            //        _html += `<a href="#" class="nav-link">
            //                <i class="fas fa-inbox"></i> item
            //            </a>`;
            //    }
            //    $('#list-online').html(_html);
            //};

            connection.hub.start().done(function () {
                $('#chat').submit(function () {
                    if ($('#message').val() !== "") {
                        chatHub.server.sendToChannel($('#channel').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    }
                    event.preventDefault();
                });
            });

            connection.hub.disconnected(function () {
                setTimeout(function () {
                    connection.hub.start();
                }, 3000); // Restart connection
            });

            $(document).on("click", ".btn-reply", function () {
                let channelId = $(this).data("channel");

                if ($("#channel").val() !== channelId) {
                    let name = $(this).data("name");
                    let timestamp = $(this).data("timestamp");

                    $("#user-name").html(name ?? "");
                    $("#user-timestamp").html(moment(timestamp ?? "").fromNow());

                    $("#channel").val(channelId);
                    chatHub.server.join(channelId);
                }

                if ($("#user-list").hasClass("col-xl-12")) {
                    $("#user-list")
                        .removeClass("col-xl-12")
                        .addClass("col-xl-5");

                    $("#chat-list").show();
                }

                $('#message').focus();
                $('#discussion')
                    .ready(function () {
                        $('#discussion').animate({ scrollTop: $('#discussion').prop("scrollHeight") }, 150);
                    });
            });


            $(document).on("click", ".btn-close", function () {
                if ($("#user-list").hasClass("col-xl-5")) {
                    $("#user-list")
                        .removeClass("col-xl-5")
                        .addClass("col-xl-12");

                    $("#chat-list").hide();
                }
            });


            $(document).on("click", "#discussion .btn-loadmore", function () {
                $(this).hide().remove();
                var msg = $(".direct-chat-msg").first().data("message");

                chatHub.server.getMessageHistory($("#channel").val(), msg ?? 0).done(function (historyMessages) {
                    console.log(historyMessages.length);
                    var msg = "";

                    for (let messageView of historyMessages) {
                        msg += connvertMessage(accountId, messageView);
                    }

                    $('#discussion').prepend(msg);

                    if (historyMessages.length >= 10) {
                        $('#discussion')
                            .prepend('<button type="button" class="btn btn-primary btn-sm btn-block mb-3 btn-loadmore">Load more message!</button>');
                    }
                });
            });

            function connvertMessage(accountId, messageView) {
                var image = `<div class="image-bx ${accountId == messageView.AccountId ? 'ml-sm-4 ml-2 mb-4' : 'mr-sm-4 mr-2'}">
                                <img src="https://vora.dexignlab.com/laravel/demo/images/users/9.png" alt="" class="rounded-circle img-1">
                                <span class="active"></span>
                            </div>`;

                return `
                        <div class="direct-chat-msg media mb-4 justify-content-${accountId == messageView.AccountId ? 'end' : 'start'}
                                align-items-${accountId == messageView.AccountId ? 'end' : 'start'}" data-message="${messageView.MessageId}">
                            ${accountId == messageView.AccountId ? '' : image}
                            <div class="${accountId == messageView.AccountId ? 'message-sent' : 'message-received'}">
                                <p class="mb-1">
                                    ${htmlEncode(messageView.Content)}
                                </p>
                                <span class="fs-12">${moment(messageView.Timestamp ?? "").fromNow()}</span>
                            </div>
                            ${accountId == messageView.AccountId ? image : '' }
                        </div>`;
            };

        });
    </script>
}