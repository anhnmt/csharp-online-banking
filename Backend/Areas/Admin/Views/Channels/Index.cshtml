@model IEnumerable<OnlineBanking.DAL.Channels>

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
@section customCss{
    <style>
        .text-custom-wrap {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* number of lines to show */
            -webkit-box-orient: vertical;
        }
    </style>
}
<div class="page-titles">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
        <li class="breadcrumb-item active"><a href="@Url.Action("Index", "Channels")">Messages</a></li>
    </ol>
</div>

<div class="row">
    <div id="user-list" class="col-xl-12">
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header d-sm-flex d-block shadow-sm border-0 align-items-center">
                        <div class="card-action card-tabs">
                            All Message
                        </div>
                    </div>
                    <div class="card-body message-bx dlab-scroll height640 ps ps--active-y" id="message-bx">
                        <div id="AllMessage">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="chat-list" class="col-xl-7" style="display: none;">
        <div class="row">
            <div class="col-xl-12">
                <div class="card message-bx chat-box">
                    <div class="card-header border-0 shadow-sm">
                        <div class="d-flex mr-auto align-items-center">
                            <div class="image-bx mr-sm-4 mr-2">
                                <img src="https://vora.dexignlab.com/laravel/demo/images/users/5.png" alt="" class="rounded-circle img-1">
                                <span class="active"></span>
                            </div>
                            <div>
                                <h5 id="user-name" class="text-black font-w600 mb-sm-1 mb-0 title-nm">User name</h5>
                                <span id="user-timestamp">Timestamp</span>
                            </div>
                        </div>

                        <button type="button" class="close btn-close" data-dismiss="modal">
                            <span>×</span>
                        </button>
                    </div>
                    <div class="card-body dlab-scroll height480 ps ps--active-y ps-trap" id="discussion">
                    </div>
                    <div class="card-footer border-0 type-massage">
                        <form id="chat" onsubmit="return false;">
                            <div class="input-group">
                                <textarea id="message" name="message" class="form-control" placeholder="Type message..."></textarea>
                                <input type="hidden" id="channel" name="channel" value="0">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Content/vendor/moment/moment.min.js" type="text/javascript"></script>
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->

    <script>
        $.connection.hub.qs = { "userId": '@Session["userId"]' };

        const connection = $.connection;
        const chatHub = connection.chatHub;
        const accountId = connection.hub.qs.userId;

        const managerChannel = {
            load: function (page = 1, key = null) {
                $.ajax({
                    type: "GET",
                    url: "/Admin/Channels/GetData",
                    data: { page: page, key: key },
                    success: function (res) {
                        let _html = "";

                        for (let item of res.data) {
                            if ($("#channel").val() === item.ChannelId) {
                                $("#user-name").html(`<a href="/Admin/Accounts/ProfileAccount/${item.AccountId ?? '0'}" onclick="return false;">${item.AccountName ?? ''}</a>`);
                                $("#user-timestamp").html(momentFromNow(item.LastUpdated ?? ""));
                            }

                            _html += `
                                <div class="media mb-4">
                                    <div class="image-bx mr-sm-4 mr-2">
                                    <img src="/Content/images/users/1.png" alt="" class="rounded-circle img-1">
                                    <span class="active"></span>
                                    </div>
                                    <div class="media-body d-sm-flex justify-content-between d-block align-items-center">
                                    <div class="mr-sm-3 mr-0">
                                        <h6 class="fs-16 font-w600 mb-sm-2 mb-0">
                                            <a href="/Admin/Accounts/ProfileAccount/${item.AccountId ?? '0'}" class="text-black">${item.AccountName ?? ""}</a>
                                        </h6>
                                        <p class="text-black mb-sm-3 mb-1 text-custom-wrap">${item.LastMessages ?? ""}</p>
                                        <span class="fs-14">${momentFromNow(item.LastUpdated ?? "")}</span>
                                    </div>
                                    <button class="btn btn-primary light rounded mt-sm-0 mt-2 btn-reply" data-account="${item.AccountId ?? '0'}" data-channel="${item.ChannelId ?? ''}" data-name="${item.AccountName ?? ''}" data-timestamp="${item.LastUpdated ?? ""}">
                                        Reply</button>
                                    </div>
                                </div>`;
                        }
                        $('#AllMessage').html(_html);
                    }
                });
            },
        };

        $(function () {
            managerChannel.load();

            $("#message").keypress(function (e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();

                    $("#chat").submit();
                }
            });

            $("#key").keyup(function () {
                let key = $("#key").val();
                managerChannel.load(1, key);
            });

            $(document).on("click", ".item-page", function () {
                let page = $(this).text();
                let key = $("#key").val();
                managerChannel.load(page, key);
            });

            chatHub.client.updateUser = function (userView) {
                console.log(userView);
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.newMessage = function (messageView) {
                const msg = convertMessage(accountId, messageView);

                $('#discussion')
                    .append(msg)
                    .ready(function () {
                        $('#discussion').animate({ scrollTop: $('#discussion').prop("scrollHeight") }, 150);
                    });
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.historyMessages = function (historyMessages) {
                if (historyMessages.length >= 10) {
                    $('#discussion')
                        .html('<button type="button" class="btn btn-primary btn-sm btn-block mb-3 btn-loadmore">Load more message!</button>');
                }
                let msg = "";

                for (let messageView of historyMessages) {
                    msg += convertMessage(accountId, messageView);
                }

                $('#discussion').append(msg);
            };

            // Create a function that the hub can call back to display messages.
            chatHub.client.reloadChatData = function () {
                managerChannel.load();
            };

            //// Create a function that the hub can call back to display messages.
            //chatHub.client.onlineList = function (data) {
            //    let _html = "";
            //    for (let item of res.data) {
            //        _html += `<a href="#" class="nav-link">
            //                <i class="fas fa-inbox"></i> item
            //            </a>`;
            //    }
            //    $('#list-online').html(_html);
            //};

            connection.hub.start().done(function () {
                $('#chat').submit(function (event) {
                    if ($('#message').val() !== "") {
                        chatHub.server.sendToChannel($('#channel').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    }
                    event.preventDefault();
                });
            });

            connection.hub.disconnected(function () {
                setTimeout(function () {
                    connection.hub.start();
                }, 3000); // Restart connection
            });

            $(document).on("click", ".btn-reply", function () {
                let channelId = $(".btn-reply").data("channel") + "";

                if ($("#channel").val() !== channelId) {
                    // $('#discussion').html('');
                    let account = $(this).data("account");
                    let name = $(this).data("name");
                    let timestamp = $(this).data("timestamp");

                    $("#user-name").html(`<a href="/Admin/Accounts/ProfileAccount/${account ?? '0'}" onclick="return false;">${name ?? ''}</a>`);
                    $("#user-timestamp").html(momentFromNow(timestamp ?? ""));

                    $("#channel").val(channelId);
                    chatHub.server.join(channelId);

                    $('#message').focus();
                    $('#discussion')
                        .ready(function () {
                            $('#discussion').animate({ scrollTop: $('#discussion').prop("scrollHeight") }, 150);
                        });
                }

                if ($("#user-list").hasClass("col-xl-12")) {
                    $("#user-list")
                        .removeClass("col-xl-12")
                        .addClass("col-xl-5");

                    $("#chat-list").show();
                }
            });

            $(document).on("click", ".btn-close", function () {
                if ($("#user-list").hasClass("col-xl-5")) {
                    $("#user-list")
                        .removeClass("col-xl-5")
                        .addClass("col-xl-12");

                    $("#chat-list").hide();
                }
            });

            $(document).on("click", "#discussion .btn-loader", function () {
                $(this).hide().remove();
                const msg = $(".direct-chat-msg").first().data("message");

                chatHub.server.getMessageHistory($("#channel").val(), msg ?? 0).done(function (historyMessages) {
                    let msg = "";

                    for (let messageView of historyMessages) {
                        msg += convertMessage(accountId, messageView);
                    }

                    $('#discussion').prepend(msg);

                    if (historyMessages.length >= 10) {
                        $('#discussion')
                            .prepend('<button type="button" class="btn btn-primary btn-sm btn-block mb-3 btn-loader">Load more message!</button>');
                    }
                });
            });

            function convertMessage(accountId, messageView) {
                const image = `<div class="image-bx ${accountId === messageView.AccountId ? 'ml-sm-4 ml-2 mb-4' : 'mr-sm-4 mr-2'}">
                                <img src="https://vora.dexignlab.com/laravel/demo/images/users/9.png" alt="" class="rounded-circle img-1">
                                <span class="active"></span>
                            </div>`;

                const username = `${accountId !== messageView.AccountId ? "<b>" + messageView.AccountName + "</b> - " : ''}${momentFromNow(messageView.Timestamp ?? "")}`;

                return `
                        <div class="direct-chat-msg media mb-4 justify-content-${accountId === messageView.AccountId ? 'end' : 'start'}
                                align-items-${accountId === messageView.AccountId ? 'end' : 'start'}" data-message="${messageView.MessageId}">
                            ${accountId === messageView.AccountId ? '' : image}
                            <div class="${accountId === messageView.AccountId ? 'message-sent' : 'message-received'}">
                                <p class="mb-1">
                                    ${htmlEncode(messageView.Content)}
                                </p>
                                <span class="fs-12">${username ?? ""}</span>
                            </div>
                            ${accountId === messageView.AccountId ? image : '' }
                        </div>`;
            }
        });
    </script>
}